<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE ALARMES - SUPABASE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="areacabecalho">
        <div id="arealogo">
            <h1><a href="#" style="color:blue; text-decoration:none;">FALHA</a><span style="color: #666;"> DE
                    INFRA</span></h1>
        </div>
    </div>

    <input type="text" id="searchInput" placeholder="Pesquisar site, munic√≠pio ou alarme..."
        style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;">

    <div class="button-group">
        <button id="addButton">‚ûï ADICIONAR NOVO REGISTRO</button>
        <button id="refreshButton">üîÑ ATUALIZAR LISTA</button>
        <button id="exportButton">‚¨áÔ∏è EXPORTAR PARA EXCEL</button>
    </div>

    <div class="table-container">
        <table id="planilha">
            <thead>
                <tr>
                    <th>UF</th>
                    <th>Munic√≠pio</th>
                    <th>TA Origem</th>
                    <th>TA Sequ√™ncia</th>
                    <th>Status TA</th>
                    <th>Topology</th>
                    <th>Site</th>
                    <th>Grupo</th>
                    <th>Alarme</th>
                    <th>Cria√ß√£o</th>
                    <th>Apresenta√ß√£o</th>
                    <th style="min-width: 110px;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO SUPABASE ---
        const SUPABASE_URL = 'https://xfxuvhonklytrvcovghr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhmeHV2aG9ua2x5dHJ2Y292Z2hyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MjM0MDIsImV4cCI6MjA4MTk5OTQwMn0.X-0Y0fqxGWD-L4xorDQk99i3EaGYGiy8yuaoDkBPhY0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- CARREGAR DADOS ---
        async function carregarDados() {
            const { data, error } = await supabaseClient
                .from('alarmes')
                .select('*')
                .order('criacao', { ascending: false });

            if (error) {
                alert("Erro ao buscar dados: " + error.message);
            } else {
                renderizarTabela(data);
            }
        }

        function renderizarTabela(dados) {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";

            dados.forEach((item) => {
                const tr = document.createElement("tr");

                // Aplicar classe de status para cor lateral no CSS
                if (item.statusTa) {
                    const statusSlug = item.statusTa.toLowerCase().replace(" ", "-");
                    tr.classList.add('status-' + statusSlug);
                }

                tr.innerHTML = `
                    <td>${item.uf}</td>
                    <td>${item.municipio || ''}</td>
                    <td>${item.taOrigem || ''}</td>
                    <td>${item.taSequencia || ''}</td>
                    <td>${item.statusTa || ''}</td>
                    <td>${item.topology || ''}</td>
                    <td>${item.site || ''}</td>
                    <td>${item.grupo || ''}</td>
                    <td>${item.alarme || ''}</td>
                    <td>${formatarData(item.criacao)}</td>
                    <td>${formatarData(item.apresentacao)}</td>
                    <td>
                        <button class="btn-edit" onclick="alternarEdicao(this, '${item.id}')">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="excluirRegistro('${item.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- ADICIONAR ---
        document.getElementById("addButton").onclick = async function () {
            const agora = new Date().toISOString();
            const novoItem = {
                uf: "RJ",
                municipio: "NOVO REGISTRO",
                statusTa: "Ativo",
                grupo: "INFRA_CAMPO",
                criacao: agora,
                apresentacao: agora
            };

            const { error } = await supabaseClient.from('alarmes').insert([novoItem]);
            if (error) alert("Erro: " + error.message);
            else carregarDados();
        };

        // --- EDITAR / SALVAR ---
        async function alternarEdicao(botao, id) {
            const tr = botao.closest('tr');

            if (!tr.classList.contains('editing')) {
                tr.classList.add('editing');
                botao.textContent = "üíæ";
                const celulas = tr.querySelectorAll('td');
                const v = Array.from(celulas).map(c => c.innerText);

                const converterParaInput = (t) => {
                    if (!t) return "";
                    const [d, h] = t.split(' ');
                    const [dia, mes, ano] = d.split('/');
                    return `${ano}-${mes}-${dia}T${h}`;
                };

                celulas[0].innerHTML = `<select><option value="RJ" ${v[0] == 'RJ' ? 'selected' : ''}>RJ</option><option value="ES" ${v[0] == 'ES' ? 'selected' : ''}>ES</option></select>`;
                celulas[1].innerHTML = `<input type="text" value="${v[1]}">`;
                celulas[2].innerHTML = `<input type="text" value="${v[2]}">`;
                celulas[3].innerHTML = `<input type="text" value="${v[3]}">`;
                celulas[4].innerHTML = `<select>
                    <option value="Ativo" ${v[4] == 'Ativo' ? 'selected' : ''}>Ativo</option>
                    <option value="Pr√© Baixa" ${v[4] == 'Pr√© Baixa' ? 'selected' : ''}>Pr√© Baixa</option>
                    <option value="Fechado" ${v[4] == 'Fechado' ? 'selected' : ''}>Fechado</option>
                </select>`;
                celulas[5].innerHTML = `<input type="text" value="${v[5]}">`;
                celulas[6].innerHTML = `<input type="text" value="${v[6]}" oninput="this.value=this.value.toUpperCase()">`;
                celulas[7].innerHTML = `<input type="text" value="${v[7]}">`; // Grupo
                celulas[8].innerHTML = `<input type="text" value="${v[8]}">`; // Alarme
                celulas[9].innerHTML = `<input type="datetime-local" value="${converterParaInput(v[9])}">`;
                celulas[10].innerHTML = `<input type="datetime-local" value="${converterParaInput(v[10])}">`;
            } else {
                const inps = tr.querySelectorAll('input, select');
                const dados = {
                    uf: inps[0].value, municipio: inps[1].value, taOrigem: inps[2].value,
                    taSequencia: inps[3].value, statusTa: inps[4].value, topology: inps[5].value,
                    site: inps[6].value.toUpperCase(), grupo: inps[7].value, alarme: inps[8].value,
                    criacao: inps[9].value ? new Date(inps[9].value).toISOString() : null,
                    apresentacao: inps[10].value ? new Date(inps[10].value).toISOString() : null
                };

                const { error } = await supabaseClient.from('alarmes').update(dados).eq('id', id);
                if (error) alert(error.message);
                else carregarDados();
            }
        }

        // --- EXCLUIR ---
        async function excluirRegistro(id) {
            if (confirm("Excluir este registro permanentemente?")) {
                const { error } = await supabaseClient.from('alarmes').delete().eq('id', id);
                if (error) alert("Erro ao excluir");
                else carregarDados();
            }
        }

        // --- AUXILIARES ---
        function formatarData(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return d.toLocaleDateString('pt-BR') + " " + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        document.getElementById("refreshButton").onclick = () => carregarDados();

        document.getElementById("searchInput").onkeyup = function () {
            const f = this.value.toLowerCase();
            document.querySelectorAll("#tableBody tr").forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(f) ? "" : "none";
            });
        };

        document.getElementById("exportButton").onclick = () => {
            const wb = XLSX.utils.table_to_book(document.getElementById('planilha'));
            XLSX.writeFile(wb, "Relatorio_Alarmes.xlsx");
        };

        window.onload = carregarDados;
    </script>
</body>

</html>