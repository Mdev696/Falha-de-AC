<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALARME INFRA/AC - Supabase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="areacabecalho">
        <h1><a href="#" style="color:blue; text-decoration:none;">FALHA</a><span style="color: #666;"> DE INFRA</span>
        </h1>
    </div>

    <input type="text" id="searchInput" placeholder="Pesquisar por UF ou Site..."
        style="width: 100%; padding: 10px; margin-bottom: 20px;">

    <div class="button-group">
        <button id="addButton">‚ûï ADICIONAR NOVO</button>
        <button id="refreshButton">üîÑ ATUALIZAR</button>
        <button id="exportButton">‚¨áÔ∏è EXPORTAR EXCEL</button>
    </div>

    <div class="table-container">
        <table id="planilha">
            <thead>
                <tr>
                    <th>UF</th>
                    <th>Munic√≠pio</th>
                    <th>TA Origem</th>
                    <th>TA Sequ√™ncia</th>
                    <th>Status TA</th>
                    <th>Topology</th>
                    <th>Site</th>
                    <th>Grupo</th>
                    <th>Alarme</th>
                    <th>Cria√ß√£o</th>
                    <th>Apresenta√ß√£o</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const SUPABASE_URL = 'https://xfxuvhonklytrvcovghr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhmeHV2aG9ua2x5dHJ2Y292Z2hyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MjM0MDIsImV4cCI6MjA4MTk5OTQwMn0.X-0Y0fqxGWD-L4xorDQk99i3EaGYGiy8yuaoDkBPhY0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function carregarDados() {
            const { data, error } = await supabaseClient.from('alarmes').select('*').order('criacao', { ascending: false });
            if (error) alert("Erro: " + error.message);
            else renderizarTabela(data);
        }

        function renderizarTabela(dados) {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";
            dados.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.uf}</td>
                    <td>${item.municipio || ''}</td>
                    <td>${item.taOrigem || ''}</td>
                    <td>${item.taSequencia || ''}</td>
                    <td>${item.statusTa || ''}</td>
                    <td>${item.topology || ''}</td>
                    <td>${item.site || ''}</td>
                    <td>${item.grupo || ''}</td>
                    <td>${item.alarme || ''}</td>
                    <td>${formatarData(item.criacao)}</td>
                    <td>${formatarData(item.apresentacao)}</td>
                    <td>
                        <button class="btn-edit" onclick="alternarEdicao(this, '${item.id}')">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="excluirRegistro('${item.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function formatarData(dataISO) {
            if (!dataISO) return "";
            const d = new Date(dataISO);
            return d.toLocaleDateString('pt-BR') + " " + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function converterParaInputData(texto) {
            if (!texto) return "";
            const [data, hora] = texto.split(' ');
            const [dia, mes, ano] = data.split('/');
            return `${ano}-${mes}-${dia}T${hora}`;
        }

        async function alternarEdicao(botao, id) {
            const tr = botao.closest('tr');
            const celulas = tr.querySelectorAll('td');

            if (!tr.classList.contains('editing')) {
                tr.classList.add('editing');
                botao.textContent = "üíæ";
                const v = Array.from(celulas).map(c => c.innerText);

                celulas[0].innerHTML = `<select><option value="RJ" ${v[0] == 'RJ' ? 'selected' : ''}>RJ</option><option value="ES" ${v[0] == 'ES' ? 'selected' : ''}>ES</option></select>`;
                celulas[1].innerHTML = `<input type="text" value="${v[1]}">`;
                celulas[2].innerHTML = `<input type="text" value="${v[2]}">`;
                celulas[3].innerHTML = `<input type="text" value="${v[3]}">`;
                celulas[4].innerHTML = `<select><option value="Ativo" ${v[4] == 'Ativo' ? 'selected' : ''}>Ativo</option><option value="Fechado" ${v[4] == 'Fechado' ? 'selected' : ''}>Fechado</option></select>`;
                celulas[5].innerHTML = `<input type="text" value="${v[5]}">`;
                celulas[6].innerHTML = `<input type="text" value="${v[6]}" oninput="this.value=this.value.toUpperCase()">`;
                celulas[7].innerHTML = `<input type="text" value="${v[7]}">`; // COLUNA GRUPO
                celulas[8].innerHTML = `<input type="text" value="${v[8]}">`; // COLUNA ALARME
                celulas[9].innerHTML = `<input type="datetime-local" value="${converterParaInputData(v[9])}">`;
                celulas[10].innerHTML = `<input type="datetime-local" value="${converterParaInputData(v[10])}">`;
            } else {
                const inps = tr.querySelectorAll('input, select');
                const dados = {
                    uf: inps[0].value, municipio: inps[1].value, taOrigem: inps[2].value,
                    taSequencia: inps[3].value, statusTa: inps[4].value, topology: inps[5].value,
                    site: inps[6].value.toUpperCase(), grupo: inps[7].value, alarme: inps[8].value,
                    criacao: inps[9].value ? new Date(inps[9].value).toISOString() : null,
                    apresentacao: inps[10].value ? new Date(inps[10].value).toISOString() : null
                };

                const { error } = await supabaseClient.from('alarmes').update(dados).eq('id', id);
                if (error) alert("Erro ao salvar: " + error.message);
                else carregarDados();
            }
        }

        async function excluirRegistro(id) {
            if (confirm("Excluir permanentemente?")) {
                const { error } = await supabaseClient.from('alarmes').delete().eq('id', id);
                if (error) alert("Erro!");
                else carregarDados();
            }
        }

        document.getElementById("addButton").onclick = async () => {
            const agora = new Date().toISOString();
            const { error } = await supabaseClient.from('alarmes').insert([{ uf: "RJ", municipio: "NOVO", statusTa: "Ativo", criacao: agora, apresentacao: agora }]);
            if (error) alert(error.message);
            else carregarDados();
        };

        document.getElementById("exportButton").onclick = () => {
            const wb = XLSX.utils.table_to_book(document.getElementById('planilha'));
            XLSX.writeFile(wb, "Relatorio_Alarmes.xlsx");
        };

        document.getElementById("refreshButton").onclick = carregarDados;
        document.getElementById("searchInput").onkeyup = function () {
            const f = this.value.toLowerCase();
            document.querySelectorAll("#tableBody tr").forEach(r => r.style.display = r.innerText.toLowerCase().includes(f) ? "" : "none");
        };

        window.onload = carregarDados;
    </script>
</body>

</html>